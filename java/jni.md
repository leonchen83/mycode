# Install jemalloc
```
$ wget https://github.com/jemalloc/jemalloc/releases/download/5.2.1/jemalloc-5.2.1.tar.bz2
$ tar -xvf jemalloc-5.2.1.tar.bz2
$ cd jemalloc-5.2.1
$ ./configure --with-jemalloc-prefix=je_ --disable-initial-exec-tls
$ make
$ make install
```

# NativeJemalloc.java

```
public class NativeJemalloc {
	
	static {
		System.loadLibrary("nje");
	}
	
	public static native void je_free(long ptr);
	
	public static native long je_malloc(long size);
	
	public static native void je_aligned_free(long ptr);
	
	public static native long je_calloc(long num, long size);
	
	public static native long je_realloc(long ptr, long size);
	
	public static native long je_aligned_alloc(long alignment, long size);
	
	public static void main(String[] args) {
		long addr = NativeJemalloc.je_malloc(1024);
		System.out.println(addr);
		NativeJemalloc.je_free(addr);
	}
}
```

# NativeJemalloc.h
```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class NativeJemalloc */

#ifndef _Included_NativeJemalloc
#define _Included_NativeJemalloc
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     NativeJemalloc
 * Method:    je_free
 * Signature: (J)V
 */
JNIEXPORT void JNICALL Java_NativeJemalloc_je_1free
  (JNIEnv *, jclass, jlong);

/*
 * Class:     NativeJemalloc
 * Method:    je_malloc
 * Signature: (J)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1malloc
  (JNIEnv *, jclass, jlong);

/*
 * Class:     NativeJemalloc
 * Method:    je_aligned_free
 * Signature: (J)V
 */
JNIEXPORT void JNICALL Java_NativeJemalloc_je_1aligned_1free
  (JNIEnv *, jclass, jlong);

/*
 * Class:     NativeJemalloc
 * Method:    je_calloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1calloc
  (JNIEnv *, jclass, jlong, jlong);

/*
 * Class:     NativeJemalloc
 * Method:    je_realloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1realloc
  (JNIEnv *, jclass, jlong, jlong);

/*
 * Class:     NativeJemalloc
 * Method:    je_aligned_alloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1aligned_1alloc
  (JNIEnv *, jclass, jlong, jlong);

#ifdef __cplusplus
}
#endif
#endif
```

# NativeJemalloc.c
```
#include <jni.h>
#include <stdio.h>
#include <jemalloc/jemalloc.h>
#include "NativeJemalloc.h"
/*
 * Class:     NativeJemalloc
 * Method:    je_free
 * Signature: (J)V
 */
JNIEXPORT void JNICALL Java_NativeJemalloc_je_1free(JNIEnv *env, jclass class, jlong ptr) {
    je_free((void*)ptr);
    return;
}

/*
 * Class:     NativeJemalloc
 * Method:    je_malloc
 * Signature: (J)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1malloc(JNIEnv *env, jclass class, jlong size) {
    return (jlong)je_malloc(size);
}

/*
 * Class:     NativeJemalloc
 * Method:    je_aligned_free
 * Signature: (J)V
 */
JNIEXPORT void JNICALL Java_NativeJemalloc_je_1aligned_1free(JNIEnv *env, jclass class, jlong ptr) {
    je_free((void*)ptr);
    return;
}

/*
 * Class:     NativeJemalloc
 * Method:    je_calloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1calloc(JNIEnv *env, jclass class, jlong num, jlong size) {
    return (jlong)je_calloc(num, size);
}
/*
 * Class:     NativeJemalloc
 * Method:    je_realloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1realloc(JNIEnv *env, jclass class, jlong ptr, jlong size) {
    return (jlong)je_realloc((void*)ptr, size);
}

/*
 * Class:     NativeJemalloc
 * Method:    je_aligned_alloc
 * Signature: (JJ)J
 */
JNIEXPORT jlong JNICALL Java_NativeJemalloc_je_1aligned_1alloc(JNIEnv *env, jclass class, jlong alignment, jlong size) {
    return (jlong)je_aligned_alloc(alignment, size);
}
```

# compile
```
$ gcc -c -fPIC NativeJemalloc.c -o NativeJemalloc.o -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -I`jemalloc-config --includedir`
$ gcc -shared -o libnje.so NativeJemalloc.o -Wl,-rpath,/usr/local/lib -L/usr/local/lib -ljemalloc

# static link
gcc -shared -Wl,-soname,libfma.so  -o lib/libfma.so src/jemalloc.pic.o src/arena.pic.o src/background_thread.pic.o src/base.pic.o src/bin.pic.o src/bitmap.pic.o src/ckh.pic.o src/ctl.pic.o src/div.pic.o src/extent.pic.o src/extent_dss.pic.o src/extent_mmap.pic.o src/hash.pic.o src/hook.pic.o src/large.pic.o src/log.pic.o src/malloc_io.pic.o src/mutex.pic.o src/mutex_pool.pic.o src/nstime.pic.o src/pages.pic.o src/prng.pic.o src/prof.pic.o src/rtree.pic.o src/safety_check.pic.o src/stats.pic.o src/sc.pic.o src/sz.pic.o src/tcache.pic.o src/test_hooks.pic.o src/ticker.pic.o src/tsd.pic.o src/witness.pic.o /home/chenby/c/Jemalloc.o  -lm  -pthread -ldl
```

# run
```
javac NativeJemalloc.java
java -Djava.library.path=. NativeJemalloc
```
